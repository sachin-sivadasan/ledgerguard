@startuml C4_LedgerGuard_Current
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title LedgerGuard - C4 Component Diagram (Current Implementation)

' External Systems
Person(developer, "Shopify App Developer", "Uses LedgerGuard")
System_Ext(firebase, "Firebase Auth", "Authentication")
System_Ext(shopify, "Shopify Partners", "OAuth & Partner API")
ContainerDb_Ext(postgres, "PostgreSQL", "Data storage")

Container_Boundary(api, "API Server (Go 1.22+)") {

    ' Interfaces Layer - IMPLEMENTED
    Component(router, "Router", "Chi Router", "Route definitions")
    Component(auth_mw, "AuthMiddleware", "Middleware", "Firebase token verification")
    Component(role_mw, "RoleMiddleware", "Middleware", "RBAC (OWNER/ADMIN)")
    Component(health_handler, "HealthHandler", "HTTP Handler", "GET /health")
    Component(oauth_handler, "OAuthHandler", "HTTP Handler", "OAuth flow endpoints")
    Component(manual_token_handler, "ManualTokenHandler", "HTTP Handler", "Manual token CRUD (ADMIN)")
    Component(app_handler, "AppHandler", "HTTP Handler", "App selection & listing")
    Component(sync_handler, "SyncHandler", "HTTP Handler", "Transaction sync endpoints")
    Component(metrics_handler, "MetricsHandler", "HTTP Handler", "Metrics & dashboard endpoints")
    Component(subscription_handler, "SubscriptionHandler", "HTTP Handler", "Subscription list & detail")

    ' Application Layer - IMPLEMENTED
    Component(sync_service, "SyncService", "App Service", "Transaction sync orchestration")
    Component(metrics_agg_service, "MetricsAggregationService", "App Service", "Period metrics from transactions")

    ' Domain Services - IMPLEMENTED
    Component(ledger_service, "LedgerService", "Domain Service", "Rebuild subscriptions from transactions")
    Component(risk_engine, "RiskEngine", "Domain Service", "Risk state classification")
    Component(metrics_engine, "MetricsEngine", "Domain Service", "MRR, usage revenue calculations")

    ' Domain Layer - IMPLEMENTED
    Component(user_entity, "User", "Entity", "id, firebase_uid, email, role, plan_tier")
    Component(partner_entity, "PartnerAccount", "Entity", "id, user_id, partner_id, encrypted_token")
    Component(app_entity, "App", "Entity", "id, partner_account_id, partner_app_id, name")
    Component(tx_entity, "Transaction", "Entity", "id, app_id, shopify_gid, shop_name, charge_type, gross_amount, net_amount")
    Component(sub_entity, "Subscription", "Entity", "id, app_id, shop_name, risk_state, status")
    Component(snapshot_entity, "DailyMetricsSnapshot", "Entity", "id, app_id, date, mrr, revenue_at_risk")
    Component(role_vo, "Role", "Value Object", "OWNER, ADMIN")
    Component(plan_vo, "PlanTier", "Value Object", "FREE, PRO")
    Component(integration_vo, "IntegrationType", "Value Object", "OAUTH, MANUAL")
    Component(charge_vo, "ChargeType", "Value Object", "RECURRING, USAGE, ONE_TIME, REFUND")
    Component(risk_vo, "RiskState", "Value Object", "SAFE, ONE_CYCLE, TWO_CYCLES, CHURNED")

    Component(user_repo_if, "UserRepository", "Interface", "User persistence contract")
    Component(partner_repo_if, "PartnerAccountRepository", "Interface", "Partner account contract")
    Component(app_repo_if, "AppRepository", "Interface", "App persistence contract")
    Component(tx_repo_if, "TransactionRepository", "Interface", "Transaction persistence contract")
    Component(sub_repo_if, "SubscriptionRepository", "Interface", "Subscription persistence contract")
    Component(snapshot_repo_if, "SnapshotRepository", "Interface", "Daily snapshot persistence contract")

    ' Infrastructure Layer - IMPLEMENTED
    Component(config, "Config", "Infrastructure", "YAML + env config loader")
    Component(user_repo, "PostgresUserRepository", "Repository", "User CRUD")
    Component(partner_repo, "PostgresPartnerAccountRepository", "Repository", "Partner account CRUD")
    Component(app_repo, "PostgresAppRepository", "Repository", "App CRUD")
    Component(tx_repo, "PostgresTransactionRepository", "Repository", "Transaction CRUD")
    Component(sub_repo, "PostgresSubscriptionRepository", "Repository", "Subscription CRUD")
    Component(snapshot_repo, "PostgresSnapshotRepository", "Repository", "Daily snapshot CRUD")
    Component(firebase_auth, "FirebaseAuthService", "External Adapter", "Token verification")
    Component(shopify_oauth, "ShopifyOAuthService", "External Adapter", "OAuth token exchange")
    Component(partner_client, "ShopifyPartnerClient", "External Adapter", "Partner API GraphQL")
    Component(crypto, "AESEncryptor", "pkg/crypto", "AES-256-GCM encryption")
}

' Relationships
Rel(developer, router, "HTTPS/REST")

Rel(router, auth_mw, "Uses")
Rel(router, role_mw, "Uses")
Rel(router, health_handler, "/health")
Rel(router, oauth_handler, "/api/v1/integrations/shopify/oauth,callback")
Rel(router, manual_token_handler, "/api/v1/integrations/shopify/token")
Rel(router, app_handler, "/api/v1/apps/*")
Rel(router, sync_handler, "/api/v1/sync/*")
Rel(router, metrics_handler, "/api/v1/apps/{id}/metrics")
Rel(router, subscription_handler, "/api/v1/apps/{id}/subscriptions")

Rel(sync_handler, sync_service, "Orchestrates sync")
Rel(metrics_handler, metrics_agg_service, "Aggregates period metrics")
Rel(subscription_handler, sub_repo_if, "Query subscriptions")

Rel(sync_service, ledger_service, "Rebuild after sync")
Rel(sync_service, partner_client, "Fetch transactions")
Rel(sync_service, tx_repo_if, "Store transactions")

Rel(ledger_service, risk_engine, "Classify risk")
Rel(ledger_service, metrics_engine, "Calculate KPIs")
Rel(ledger_service, sub_repo_if, "Rebuild subscriptions")
Rel(ledger_service, snapshot_repo_if, "Save daily snapshots")

Rel(metrics_agg_service, snapshot_repo_if, "Get point-in-time metrics")
Rel(metrics_agg_service, tx_repo_if, "Calculate period revenue")
Rel(metrics_agg_service, metrics_engine, "Sum usage/total revenue")

Rel(auth_mw, firebase_auth, "Verifies token")
Rel(auth_mw, user_repo_if, "Find/create user")
Rel(role_mw, user_entity, "Checks role")

Rel(oauth_handler, shopify_oauth, "OAuth flow")
Rel(oauth_handler, partner_repo_if, "Store account")
Rel(oauth_handler, crypto, "Encrypt token")

Rel(manual_token_handler, partner_repo_if, "CRUD account")
Rel(manual_token_handler, crypto, "Encrypt/decrypt token")

Rel(app_handler, partner_repo_if, "Get partner account")
Rel(app_handler, app_repo_if, "CRUD apps")
Rel(app_handler, partner_client, "Fetch apps")
Rel(app_handler, crypto, "Decrypt token")

Rel(user_repo_if, user_repo, "Implements")
Rel(partner_repo_if, partner_repo, "Implements")
Rel(app_repo_if, app_repo, "Implements")
Rel(tx_repo_if, tx_repo, "Implements")
Rel(sub_repo_if, sub_repo, "Implements")
Rel(snapshot_repo_if, snapshot_repo, "Implements")

Rel(firebase_auth, firebase, "Admin SDK")
Rel(shopify_oauth, shopify, "OAuth 2.0")
Rel(partner_client, shopify, "GraphQL API")
Rel(user_repo, postgres, "SQL")
Rel(partner_repo, postgres, "SQL")
Rel(app_repo, postgres, "SQL")
Rel(tx_repo, postgres, "SQL")
Rel(sub_repo, postgres, "SQL")
Rel(snapshot_repo, postgres, "SQL")

SHOW_LEGEND()
@enduml
