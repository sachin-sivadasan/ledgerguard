@startuml ER_LedgerGuard_Current
!theme plain
skinparam linetype ortho

title LedgerGuard - Entity Relationship Diagram (Current Implementation)

entity "users" as users {
  *id : UUID <<PK>>
  --
  *firebase_uid : VARCHAR(128) <<UNIQUE>>
  *email : VARCHAR(255)
  *role : VARCHAR(20) <<CHECK: OWNER, ADMIN>>
  plan_tier : VARCHAR(20) <<DEFAULT: FREE>>
  created_at : TIMESTAMPTZ
}

entity "partner_accounts" as partner_accounts {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK>>
  *integration_type : VARCHAR(20) <<CHECK: OAUTH, MANUAL>>
  *partner_id : VARCHAR(100)
  *encrypted_access_token : BYTEA
  created_at : TIMESTAMPTZ
}

entity "apps" as apps {
  *id : UUID <<PK>>
  --
  *partner_account_id : UUID <<FK>>
  *partner_app_id : VARCHAR(100)
  *name : VARCHAR(255)
  tracking_enabled : BOOLEAN <<DEFAULT: TRUE>>
  revenue_share_tier : VARCHAR(20) <<DEFAULT: SMALL_DEV_0>>
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
  <<UNIQUE: partner_account_id, partner_app_id>>
}

entity "transactions" as transactions {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  *myshopify_domain : VARCHAR(255)
  shop_name : VARCHAR(255)
  *charge_type : VARCHAR(20) <<CHECK: RECURRING, USAGE, ONE_TIME, REFUND>>
  gross_amount_cents : BIGINT
  shopify_fee_cents : BIGINT
  processing_fee_cents : BIGINT
  tax_on_fees_cents : BIGINT
  net_amount_cents : BIGINT
  *amount_cents : BIGINT
  currency : VARCHAR(3) <<DEFAULT: USD>>
  *transaction_date : TIMESTAMPTZ
  created_date : TIMESTAMPTZ
  available_date : TIMESTAMPTZ
  earnings_status : VARCHAR(20) <<DEFAULT: PENDING>>
  --
  ' Shop details (migration 000020)
  shopify_shop_gid : VARCHAR(255)
  shop_plan : VARCHAR(100)
  --
  ' Subscription reference (migration 000020)
  subscription_gid : VARCHAR(255)
  subscription_status : VARCHAR(50)
  subscription_period_end : TIMESTAMPTZ
  billing_interval : VARCHAR(20)
  --
  created_at : TIMESTAMPTZ
}

entity "subscriptions" as subscriptions {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  shopify_shop_gid : VARCHAR(255)
  *myshopify_domain : VARCHAR(255)
  shop_name : VARCHAR(255)
  plan_name : VARCHAR(255)
  *base_price_cents : BIGINT
  currency : VARCHAR(3) <<DEFAULT: USD>>
  billing_interval : VARCHAR(20) <<CHECK: MONTHLY, ANNUAL>>
  *status : VARCHAR(20) <<CHECK: ACTIVE, CANCELLED, FROZEN, PENDING, UNINSTALLED>>
  last_recurring_charge_date : TIMESTAMPTZ
  expected_next_charge_date : TIMESTAMPTZ
  *risk_state : VARCHAR(30) <<CHECK: SAFE, ONE_CYCLE_MISSED, TWO_CYCLES_MISSED, CHURNED>>
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
  deleted_at : TIMESTAMPTZ <<SOFT DELETE>>
}

entity "subscription_events" as subscription_events {
  *id : UUID <<PK>>
  --
  *subscription_id : UUID <<FK>>
  *from_status : VARCHAR(50)
  *to_status : VARCHAR(50)
  *from_risk_state : VARCHAR(50)
  *to_risk_state : VARCHAR(50)
  *event_type : VARCHAR(50) <<CHECK: webhook, sync, manual, billing_failure, app_uninstalled>>
  reason : TEXT
  *occurred_at : TIMESTAMPTZ
  created_at : TIMESTAMPTZ
}

entity "daily_metrics_snapshot" as daily_metrics_snapshot {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *date : DATE
  active_mrr_cents : BIGINT
  revenue_at_risk_cents : BIGINT
  usage_revenue_cents : BIGINT
  total_revenue_cents : BIGINT
  renewal_success_rate : DECIMAL(5,4)
  safe_count : INT
  one_cycle_missed_count : INT
  two_cycles_missed_count : INT
  churned_count : INT
  total_subscriptions : INT
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
  <<UNIQUE: app_id, date>>
}

entity "daily_insight" as daily_insight {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *date : DATE
  *insight_text : TEXT
  created_at : TIMESTAMPTZ
  <<UNIQUE: app_id, date>>
}

entity "device_tokens" as device_tokens {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK>>
  *device_token : TEXT <<UNIQUE>>
  *platform : VARCHAR(20) <<CHECK: ios, android, web>>
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
}

entity "notification_preferences" as notification_preferences {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK, UNIQUE>>
  critical_enabled : BOOLEAN <<DEFAULT: TRUE>>
  daily_summary_enabled : BOOLEAN <<DEFAULT: TRUE>>
  daily_summary_time : TIME <<DEFAULT: 08:00>>
  slack_webhook_url : TEXT
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
}

entity "user_preferences" as user_preferences {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK, UNIQUE>>
  primary_kpis : TEXT[]
  secondary_widgets : TEXT[]
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
}

entity "api_keys" as api_keys {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK>>
  *name : VARCHAR(100)
  *key_hash : VARCHAR(64) <<UNIQUE>>
  rate_limit_per_minute : INT <<DEFAULT: 60>>
  is_active : BOOLEAN <<DEFAULT: TRUE>>
  created_at : TIMESTAMPTZ
  revoked_at : TIMESTAMPTZ
}

entity "api_audit_log" as api_audit_log {
  *id : UUID <<PK>>
  --
  *api_key_id : UUID <<FK>>
  *endpoint : VARCHAR(255)
  *method : VARCHAR(10)
  request_params : JSONB
  *response_status : INT
  *response_time_ms : INT
  ip_address : VARCHAR(45)
  user_agent : TEXT
  created_at : TIMESTAMPTZ
}

entity "api_subscription_status" as api_subscription_status {
  *id : UUID <<PK>>
  --
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  *app_id : UUID
  *myshopify_domain : VARCHAR(255)
  shop_name : VARCHAR(255)
  plan_name : VARCHAR(255)
  *risk_state : VARCHAR(30) <<CHECK: SAFE, ONE_CYCLE_MISSED, TWO_CYCLES_MISSED, CHURNED>>
  *is_paid_current_cycle : BOOLEAN
  months_overdue : INT <<DEFAULT: 0>>
  last_successful_charge_date : TIMESTAMPTZ
  expected_next_charge_date : TIMESTAMPTZ
  *status : VARCHAR(20) <<CHECK: ACTIVE, CANCELLED, FROZEN, PENDING>>
  last_synced_at : TIMESTAMPTZ
}

entity "api_usage_status" as api_usage_status {
  *id : UUID <<PK>>
  --
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  *subscription_shopify_gid : VARCHAR(255)
  *subscription_id : UUID
  billed : BOOLEAN <<DEFAULT: FALSE>>
  billing_date : TIMESTAMPTZ
  *amount_cents : INT
  description : TEXT
  last_synced_at : TIMESTAMPTZ
}

' Core Relationships
users ||--o{ partner_accounts : "has"
users ||--o{ device_tokens : "registers"
users ||--o| notification_preferences : "configures"
users ||--o| user_preferences : "customizes"
users ||--o{ api_keys : "manages"
partner_accounts ||--o{ apps : "tracks"
apps ||--o{ transactions : "records"
apps ||--o{ subscriptions : "has"
apps ||--o{ daily_metrics_snapshot : "snapshots"
apps ||--o{ daily_insight : "insights"
subscriptions ||--o{ subscription_events : "logs"
api_keys ||--o{ api_audit_log : "audits"

' CQRS Read Model (denormalized, populated from subscriptions/transactions)
apps ..> api_subscription_status : "populates"
apps ..> api_usage_status : "populates"

note right of users
  Migration: 000001_create_users_table
  - Firebase authentication
  - Role-based access control
end note

note right of partner_accounts
  Migration: 000002_create_partner_accounts_table
  - Shopify Partner OAuth
  - AES-256-GCM encrypted tokens

  Indexes:
  - idx_partner_accounts_user_id
  - idx_partner_accounts_partner_id
end note

note right of apps
  Migration: 000003_create_apps_table
  Migration: 000017_add_revenue_share_tier
  - Shopify apps being tracked
  - One app selected per user
  - Revenue share tier (0%, 15%, 20%)

  Indexes:
  - idx_apps_partner_account_id
  - idx_apps_tracking_enabled
end note

note right of transactions
  Migrations: 000004, 000011, 000017, 000018, 000020
  - Immutable ledger of transactions
  - Upsert by shopify_gid (idempotent)
  - shop_name: Store display name
  - gross_amount: Subscription price (pre-Shopify cut)
  - Fee breakdown: shopify_fee, processing_fee, tax
  - Earnings tracking: PENDING → AVAILABLE → PAID_OUT
  - Subscription reference for AppSubscriptionSale

  Indexes:
  - idx_transactions_app_date
  - idx_transactions_domain
  - idx_transactions_type
  - idx_transactions_earnings
  - idx_transactions_subscription_gid
  - idx_transactions_subscription_status
end note

note right of subscriptions
  Migrations: 000005, 000010, 000016, 000021, 000022
  - Rebuilt from transactions (deterministic)
  - Tracks last_recurring_charge_date
  - Computes expected_next_charge_date
  - Risk classification
  - Soft delete support (deleted_at)
  - Shop GID for webhook/event lookup

  Indexes:
  - idx_subscriptions_app_status
  - idx_subscriptions_app_risk
  - idx_subscriptions_domain
  - idx_subscriptions_expected_charge
  - idx_subscriptions_shop_gid
end note

note right of subscription_events
  Migration: 000023_create_subscription_events_table
  - Lifecycle event audit trail
  - Tracks status and risk state transitions
  - Supports churn analysis (voluntary vs involuntary)
  - Event types: webhook, sync, billing_failure, app_uninstalled

  Indexes:
  - idx_subscription_events_subscription_id
  - idx_subscription_events_type_occurred
  - idx_subscription_events_churn (partial)
end note

note right of daily_metrics_snapshot
  Migration: 000006_create_daily_metrics_snapshot_table
  - Immutable daily KPI snapshots
  - One per app per day (never deleted)
  - Computed by MetricsEngine

  Metrics:
  - Active MRR (SAFE only)
  - Revenue at Risk (ONE_CYCLE + TWO_CYCLES)
  - Usage Revenue / Total Revenue
  - Renewal Success Rate

  Indexes:
  - idx_daily_metrics_app_date
  - idx_daily_metrics_app_latest
end note

note right of daily_insight
  Migration: 000007_create_daily_insight_table
  - AI-generated executive briefs (80-120 words)
  - Pro tier only (gated by plan_tier)
  - Generated from DailyMetricsSnapshot

  Indexes:
  - idx_daily_insight_app_date
end note

note right of user_preferences
  Migration: 000019_create_user_preferences_table
  - Dashboard KPI configuration
  - Widget visibility preferences
  - Per-user customization

  Indexes:
  - idx_user_preferences_user_id
end note

note right of api_keys
  Migration: 000012_create_api_keys_table
  - Revenue API access keys
  - SHA-256 hashed (raw key never stored)
  - Rate limiting per key
  - Owner role only

  Indexes:
  - idx_api_keys_user_id
  - idx_api_keys_key_hash
end note

note right of api_audit_log
  Migration: 000015_create_api_audit_log_table
  - Revenue API request logging
  - Debugging and compliance
  - Error tracking

  Indexes:
  - idx_api_audit_key_created
  - idx_api_audit_created
  - idx_api_audit_errors (partial)
end note

note bottom of api_subscription_status
  Migration: 000013 (CQRS Read Model)
  - Populated from subscriptions after sync
  - Optimized for Revenue API queries
  - Denormalized for fast lookups
end note

note bottom of api_usage_status
  Migration: 000014 (CQRS Read Model)
  - Populated from usage transactions
  - Tracks billed/unbilled usage
  - Links to parent subscription
end note

@enduml
