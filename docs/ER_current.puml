@startuml ER_LedgerGuard_Current
!theme plain
skinparam linetype ortho

title LedgerGuard - Entity Relationship Diagram (Current Implementation)

entity "users" as users {
  *id : UUID <<PK>>
  --
  *firebase_uid : VARCHAR(128) <<UNIQUE>>
  *email : VARCHAR(255)
  *role : VARCHAR(20) <<CHECK: OWNER, ADMIN>>
  plan_tier : VARCHAR(20) <<DEFAULT: FREE>>
  created_at : TIMESTAMPTZ
}

entity "partner_accounts" as partner_accounts {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK>>
  *integration_type : VARCHAR(20) <<CHECK: OAUTH, MANUAL>>
  *partner_id : VARCHAR(100)
  *encrypted_access_token : BYTEA
  created_at : TIMESTAMPTZ
}

entity "apps" as apps {
  *id : UUID <<PK>>
  --
  *partner_account_id : UUID <<FK>>
  *partner_app_id : VARCHAR(100)
  *name : VARCHAR(255)
  tracking_enabled : BOOLEAN <<DEFAULT: TRUE>>
  created_at : TIMESTAMPTZ
  <<UNIQUE: partner_account_id, partner_app_id>>
}

entity "transactions" as transactions {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  *myshopify_domain : VARCHAR(255)
  *charge_type : VARCHAR(20) <<CHECK: RECURRING, USAGE, ONE_TIME, REFUND>>
  *amount_cents : BIGINT
  currency : VARCHAR(3) <<DEFAULT: USD>>
  *transaction_date : TIMESTAMPTZ
  created_at : TIMESTAMPTZ
}

entity "subscriptions" as subscriptions {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  *myshopify_domain : VARCHAR(255)
  plan_name : VARCHAR(255)
  *base_price_cents : BIGINT
  currency : VARCHAR(3) <<DEFAULT: USD>>
  billing_interval : VARCHAR(20) <<CHECK: MONTHLY, ANNUAL>>
  *status : VARCHAR(20) <<CHECK: ACTIVE, CANCELLED, FROZEN, PENDING>>
  last_recurring_charge_date : TIMESTAMPTZ
  expected_next_charge_date : TIMESTAMPTZ
  *risk_state : VARCHAR(30) <<CHECK: SAFE, ONE_CYCLE_MISSED, TWO_CYCLES_MISSED, CHURNED>>
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
}

entity "daily_metrics_snapshot" as daily_metrics_snapshot {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *date : DATE
  active_mrr_cents : BIGINT
  revenue_at_risk_cents : BIGINT
  usage_revenue_cents : BIGINT
  total_revenue_cents : BIGINT
  renewal_success_rate : DECIMAL(5,4)
  safe_count : INT
  one_cycle_missed_count : INT
  two_cycles_missed_count : INT
  churned_count : INT
  total_subscriptions : INT
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
  <<UNIQUE: app_id, date>>
}

entity "daily_insight" as daily_insight {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *date : DATE
  *insight_text : TEXT
  created_at : TIMESTAMPTZ
  <<UNIQUE: app_id, date>>
}

' Relationships
users ||--o{ partner_accounts : "has"
partner_accounts ||--o{ apps : "tracks"
apps ||--o{ transactions : "records"
apps ||--o{ subscriptions : "has"
apps ||--o{ daily_metrics_snapshot : "snapshots"
apps ||--o{ daily_insight : "insights"

note right of users
  Migration: 000001_create_users_table
  - Firebase authentication
  - Role-based access control
end note

note right of partner_accounts
  Migration: 000002_create_partner_accounts_table
  - Shopify Partner OAuth
  - AES-256-GCM encrypted tokens

  Indexes:
  - idx_partner_accounts_user_id
  - idx_partner_accounts_partner_id
end note

note right of apps
  Migration: 000003_create_apps_table
  - Shopify apps being tracked
  - One app selected per user

  Indexes:
  - idx_apps_partner_account_id
  - idx_apps_tracking_enabled
end note

note right of transactions
  Migration: 000004_create_transactions_table
  - Immutable ledger of transactions
  - Upsert by shopify_gid (idempotent)

  Indexes:
  - idx_transactions_app_date
  - idx_transactions_domain
  - idx_transactions_type
end note

note right of subscriptions
  Migration: 000005_create_subscriptions_table
  - Rebuilt from transactions (deterministic)
  - Tracks last_recurring_charge_date
  - Computes expected_next_charge_date
  - Risk classification

  Indexes:
  - idx_subscriptions_app_status
  - idx_subscriptions_app_risk
  - idx_subscriptions_domain
  - idx_subscriptions_expected_charge
end note

note right of daily_metrics_snapshot
  Migration: 000006_create_daily_metrics_snapshot_table
  - Immutable daily KPI snapshots
  - One per app per day (never deleted)
  - Computed by MetricsEngine

  Metrics:
  - Active MRR (SAFE only)
  - Revenue at Risk (ONE_CYCLE + TWO_CYCLES)
  - Usage Revenue / Total Revenue
  - Renewal Success Rate

  Indexes:
  - idx_daily_metrics_app_date
  - idx_daily_metrics_app_latest
end note

note right of daily_insight
  Migration: 000007_create_daily_insight_table
  - AI-generated executive briefs (80-120 words)
  - Pro tier only (gated by plan_tier)
  - Generated from DailyMetricsSnapshot

  Indexes:
  - idx_daily_insight_app_date
end note

@enduml
