@startuml ER_LedgerGuard_Current
!theme plain
skinparam linetype ortho

title LedgerGuard - Entity Relationship Diagram (Current Implementation)

entity "users" as users {
  *id : UUID <<PK>>
  --
  *firebase_uid : VARCHAR(128) <<UNIQUE>>
  *email : VARCHAR(255)
  *role : VARCHAR(20) <<CHECK: OWNER, ADMIN>>
  plan_tier : VARCHAR(20) <<DEFAULT: FREE>>
  created_at : TIMESTAMPTZ
}

entity "partner_accounts" as partner_accounts {
  *id : UUID <<PK>>
  --
  *user_id : UUID <<FK>>
  *integration_type : VARCHAR(20) <<CHECK: OAUTH, MANUAL>>
  *partner_id : VARCHAR(100)
  *encrypted_access_token : BYTEA
  created_at : TIMESTAMPTZ
}

entity "apps" as apps {
  *id : UUID <<PK>>
  --
  *partner_account_id : UUID <<FK>>
  *partner_app_id : VARCHAR(100)
  *name : VARCHAR(255)
  tracking_enabled : BOOLEAN <<DEFAULT: TRUE>>
  created_at : TIMESTAMPTZ
  <<UNIQUE: partner_account_id, partner_app_id>>
}

entity "transactions" as transactions {
  *id : UUID <<PK>>
  --
  *app_id : UUID <<FK>>
  *shopify_gid : VARCHAR(255) <<UNIQUE>>
  *myshopify_domain : VARCHAR(255)
  *charge_type : VARCHAR(20) <<CHECK: RECURRING, USAGE, ONE_TIME, REFUND>>
  *amount_cents : BIGINT
  currency : VARCHAR(3) <<DEFAULT: USD>>
  *transaction_date : TIMESTAMPTZ
  created_at : TIMESTAMPTZ
}

' Relationships
users ||--o{ partner_accounts : "has"
partner_accounts ||--o{ apps : "tracks"
apps ||--o{ transactions : "records"

note right of users
  Migration: 000001_create_users_table
  - Firebase authentication
  - Role-based access control
end note

note right of partner_accounts
  Migration: 000002_create_partner_accounts_table
  - Shopify Partner OAuth
  - AES-256-GCM encrypted tokens

  Indexes:
  - idx_partner_accounts_user_id
  - idx_partner_accounts_partner_id
end note

note right of apps
  Migration: 000003_create_apps_table
  - Shopify apps being tracked
  - One app selected per user

  Indexes:
  - idx_apps_partner_account_id
  - idx_apps_tracking_enabled
end note

note right of transactions
  Migration: 000004_create_transactions_table
  - Immutable ledger of transactions
  - Upsert by shopify_gid (idempotent)

  Indexes:
  - idx_transactions_app_date
  - idx_transactions_domain
  - idx_transactions_type
end note

@enduml
